package com.learn.user.nacos;

import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.Properties;

import javax.annotation.PostConstruct;

import org.springframework.beans.factory.annotation.Value;
// import org.springframework.stereotype.Component;

import com.alibaba.nacos.api.NacosFactory;
import com.alibaba.nacos.api.exception.NacosException;
import com.alibaba.nacos.api.naming.NamingService;
import com.alibaba.nacos.api.naming.pojo.Instance;

import lombok.extern.slf4j.Slf4j;

@Slf4j
// @Component
public class NacosRegister {
    
    @Value("${nacos.server-addr:localhost:8848}")
    private String nacosServerAddr;  // Nacos服务地址
    
    @Value("${spring.application.name:user-service}")
    private String serviceName;  // 服务名称
    
    @Value("${server.port:8081}")
    private int port;  // Nacos服务地址

    /**
     * 项目启动后自动注册到Nacos
     */
    @PostConstruct
    public void registerToNacos() {
        try {
            // 1. 创建Nacos配置
            Properties properties = new Properties();
            properties.put("serverAddr", nacosServerAddr);

             // 2. 获取Nacos命名服务
            NamingService namingService = NacosFactory.createNamingService(properties);

            // 3. 获取本机IP
            String ip = InetAddress.getLocalHost().getHostAddress();

            // 4. 创建实例
            Instance instance = new Instance();
            instance.setIp(ip);
            instance.setPort(port);
            instance.setHealthy(true);
            instance.setEnabled(true);

            // 5. 注册服务
            namingService.registerInstance(serviceName, instance);
            log.info("===== Server {} regist to Nacos success! IP:{}:{} =====", serviceName, ip, port);

        } catch (NacosException | UnknownHostException e) {
            log.error("Regist to Nacos failed.", e);
        }
    }
}
